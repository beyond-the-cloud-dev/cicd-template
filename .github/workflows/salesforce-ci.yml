name: Reusable Salesforce CI

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      sf-cli-version:
        description: 'Salesforce CLI version to use (e.g., "2.0.0" or "latest")'
        required: false
        type: string
        default: 'latest'
      scratch-org-duration:
        description: 'Scratch org duration in days'
        required: false
        type: number
        default: 1
      scratch-org-wait:
        description: 'Wait time for scratch org creation (minutes)'
        required: false
        type: number
        default: 30
      deploy-wait:
        description: 'Wait time for deployment (minutes)'
        required: false
        type: number
        default: 30
      test-wait:
        description: 'Wait time for tests (minutes)'
        required: false
        type: number
        default: 30
      test-level:
        description: 'Test level (RunLocalTests, RunAllTestsInOrg, etc.)'
        required: false
        type: string
        default: 'RunLocalTests'
      scratch-def-file:
        description: 'Path to scratch org definition file'
        required: false
        type: string
        default: 'config/project-scratch-def.json'
      upload-to-codecov:
        description: 'Upload coverage to Codecov'
        required: false
        type: boolean
        default: false
      codecov-slug:
        description: 'Codecov repository slug (org/repo)'
        required: false
        type: string
        default: ''
    secrets:
      SFDX_AUTH_URL_DEVHUB:
        description: 'SFDX Auth URL for Dev Hub'
        required: true
      CODECOV_TOKEN:
        description: 'Codecov token for coverage upload'
        required: false

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout source code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: üì¶ Cache Salesforce CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-sf-cli-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-sf-cli-

      - name: ‚ö° Install Salesforce CLI ${{ inputs.sf-cli-version }}
        run: |
          if [ "${{ inputs.sf-cli-version }}" = "latest" ]; then
            npm install @salesforce/cli --global
          else
            npm install @salesforce/cli@${{ inputs.sf-cli-version }} --global
          fi
          sf --version

      - name: üîê Authorize Dev Hub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL_DEVHUB }}" | sf org login sfdx-url --alias DevHub --set-default-dev-hub --sfdx-url-stdin
          echo "‚úì Successfully authenticated with Dev Hub"

      - name: üå± Create scratch org
        run: |
          sf org create scratch \
            --definition-file ${{ inputs.scratch-def-file }} \
            --alias ScratchOrg \
            --wait ${{ inputs.scratch-org-wait }} \
            --duration-days ${{ inputs.scratch-org-duration }} \
            --set-default
          echo "‚úì Successfully created scratch org"

      - name: üöÄ Deploy source to scratch org
        run: |
          sf project deploy start --target-org ScratchOrg --wait ${{ inputs.deploy-wait }}
          echo "‚úì Successfully deployed source"

      - name: üß™ Run Apex tests
        run: |
          sf apex run test \
            --target-org ScratchOrg \
            --code-coverage \
            --result-format human \
            --output-dir ./tests/apex \
            --test-level ${{ inputs.test-level }} \
            --wait ${{ inputs.test-wait }}

      - name: üìä Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apex-test-results
          path: ./tests/apex
          retention-days: 30

      - name: üìà Upload coverage to Codecov
        if: inputs.upload-to-codecov && success()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: ${{ inputs.codecov-slug }}
          flags: Apex
          files: ./tests/apex/test-result-codecoverage.json

      - name: üßπ Cleanup scratch org
        if: always()
        run: |
          sf org delete scratch --target-org ScratchOrg --no-prompt || true
          echo "‚úì Scratch org cleanup completed"
