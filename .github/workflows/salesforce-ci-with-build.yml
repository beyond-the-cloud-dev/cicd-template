name: Salesforce CI with Build Step

# Reusable workflow for Salesforce projects that need to build source before deployment
# Copy this file to: beyond-the-cloud-dev/cicd-template/.github/workflows/salesforce-ci-with-build.yml

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      sf-cli-version:
        description: 'Salesforce CLI version to use (e.g., "2.0.0" or "latest")'
        required: false
        type: string
        default: 'latest'
      scratch-org-duration:
        description: 'Scratch org duration in days'
        required: false
        type: number
        default: 1
      scratch-org-wait:
        description: 'Wait time for scratch org creation (minutes)'
        required: false
        type: number
        default: 30
      deploy-wait:
        description: 'Wait time for deployment (minutes)'
        required: false
        type: number
        default: 30
      test-wait:
        description: 'Wait time for tests (minutes)'
        required: false
        type: number
        default: 30
      test-level:
        description: 'Test level (RunLocalTests, RunAllTestsInOrg, etc.)'
        required: false
        type: string
        default: 'RunLocalTests'
      scratch-def-file:
        description: 'Path to scratch org definition file'
        required: false
        type: string
        default: 'config/project-scratch-def.json'
      upload-to-codecov:
        description: 'Upload coverage to Codecov'
        required: false
        type: boolean
        default: false
      codecov-slug:
        description: 'Codecov repository slug (org/repo)'
        required: false
        type: string
        default: ''
      build-command:
        description: 'Command to build/generate source code (e.g., "npm run build", "npm run package:build")'
        required: true
        type: string
      build-artifact-path:
        description: 'Path to the built source code directory (e.g., "force-app", "dist")'
        required: false
        type: string
        default: 'force-app'
      checkout-submodules:
        description: 'Whether to checkout git submodules'
        required: false
        type: boolean
        default: false
    secrets:
      SFDX_AUTH_URL_DEVHUB:
        description: 'SFDX Auth URL for Dev Hub'
        required: true
      CODECOV_TOKEN:
        description: 'Codecov token for coverage upload'
        required: false

jobs:
  build-deploy-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.checkout-submodules && 'recursive' || 'false' }}

      - name: ğŸŸ¢ Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: ğŸ“¦ Install Node dependencies
        run: npm ci

      - name: ğŸ”¨ Build source code
        run: ${{ inputs.build-command }}
        env:
          NODE_ENV: production

      - name: âœ… Verify build output
        run: |
          if [ ! -d "${{ inputs.build-artifact-path }}" ]; then
            echo "âŒ Build artifact directory not found: ${{ inputs.build-artifact-path }}"
            echo "   The build command may have failed or the path is incorrect."
            exit 1
          fi

          FILE_COUNT=$(find "${{ inputs.build-artifact-path }}" -type f | wc -l)
          echo "âœ… Build successful!"
          echo "   Artifact path: ${{ inputs.build-artifact-path }}"
          echo "   Total files: $FILE_COUNT"

          # Show directory structure for debugging
          echo ""
          echo "ğŸ“ Build artifact structure:"
          tree -L 3 "${{ inputs.build-artifact-path }}" || find "${{ inputs.build-artifact-path }}" -type d -maxdepth 3

      - name: ğŸ“¦ Cache Salesforce CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-sf-cli-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-sf-cli-

      - name: âš¡ Install Salesforce CLI ${{ inputs.sf-cli-version }}
        run: |
          if [ "${{ inputs.sf-cli-version }}" = "latest" ]; then
            npm install @salesforce/cli --global
          else
            npm install @salesforce/cli@${{ inputs.sf-cli-version }} --global
          fi
          sf --version

      - name: ğŸ” Authorize Dev Hub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL_DEVHUB }}" | sf org login sfdx-url --alias DevHub --set-default-dev-hub --sfdx-url-stdin
          echo "âœ“ Successfully authenticated with Dev Hub"

      - name: ğŸŒ± Create scratch org
        run: |
          sf org create scratch \
            --definition-file ${{ inputs.scratch-def-file }} \
            --alias ScratchOrg \
            --wait ${{ inputs.scratch-org-wait }} \
            --duration-days ${{ inputs.scratch-org-duration }} \
            --set-default
          echo "âœ“ Successfully created scratch org"

      - name: ğŸš€ Deploy source to scratch org
        run: |
          sf project deploy start --target-org ScratchOrg --wait ${{ inputs.deploy-wait }}
          echo "âœ“ Successfully deployed source"

      - name: ğŸ§ª Run Apex tests
        id: run-tests
        continue-on-error: true
        run: |
          sf apex run test \
            --target-org ScratchOrg \
            --code-coverage \
            --result-format human \
            --output-dir ./tests/apex \
            --test-level ${{ inputs.test-level }} \
            --wait ${{ inputs.test-wait }}

      - name: ğŸ“Š Parse test results and create report
        if: always()
        id: parse-results
        run: |
          REPORT_FILE="./tests/apex/test-failures-report.log"
          SUMMARY_FILE="./tests/apex/test-summary.txt"

          mkdir -p ./tests/apex

          # Find the test result JSON file (format: test-result-{ID}.json)
          TEST_RESULT_FILE=$(find ./tests/apex -name "test-result-*.json" -not -name "*codecoverage*" -not -name "*junit*" | head -1)

          if [ -z "$TEST_RESULT_FILE" ]; then
            echo "âš ï¸ No test results found" > "$SUMMARY_FILE"
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“„ Found test results: $TEST_RESULT_FILE"

          # Parse test results using jq
          TOTAL_TESTS=$(jq -r '.summary.testsRan // 0' "$TEST_RESULT_FILE")
          PASSED=$(jq -r '.summary.passing // 0' "$TEST_RESULT_FILE")
          FAILED=$(jq -r '.summary.failing // 0' "$TEST_RESULT_FILE")
          SKIPPED=$(jq -r '.summary.skipped // 0' "$TEST_RESULT_FILE")

          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          # Create summary
          {
            echo "=========================================="
            echo "     APEX TEST EXECUTION SUMMARY"
            echo "=========================================="
            echo ""
            echo "ğŸ“Š Total Tests: $TOTAL_TESTS"
            echo "âœ… Passed: $PASSED"
            echo "âŒ Failed: $FAILED"
            echo "â­ï¸  Skipped: $SKIPPED"
            echo ""
          } > "$SUMMARY_FILE"

          if [ "$FAILED" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT

            {
              echo "=========================================="
              echo "        FAILED TEST DETAILS"
              echo "=========================================="
              echo ""
            } >> "$REPORT_FILE"

            # Extract failed tests with full details
            jq -r '.tests[] | select(.Outcome == "Fail") |
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              "âŒ TEST FAILED: \(.FullName)\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              "Class: \(.ApexClass.Name)\n" +
              "Method: \(.MethodName)\n" +
              "Message: \(.Message // "No message")\n" +
              "Stack Trace:\n\(.StackTrace // "No stack trace available")\n" +
              "Runtime: \(.RunTime)ms\n" +
              "\n"' "$TEST_RESULT_FILE" >> "$REPORT_FILE"

            # Create shortened summary for PR comment
            {
              echo ""
              echo "Failed Tests:"
              echo ""
            } >> "$SUMMARY_FILE"

            jq -r '.tests[] | select(.Outcome == "Fail") |
              "â€¢ \(.ApexClass.Name).\(.MethodName)\n  â””â”€ \(.Message // "No message")"' \
              "$TEST_RESULT_FILE" >> "$SUMMARY_FILE"
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "" >> "$SUMMARY_FILE"
            echo "ğŸ‰ All tests passed successfully!" >> "$SUMMARY_FILE"
          fi

          cat "$SUMMARY_FILE"

      - name: ğŸ“Š Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apex-test-results
          path: ./tests/apex
          retention-days: 30

      - name: ğŸ’¬ Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = './tests/apex/test-summary.txt';

            if (!fs.existsSync(path)) {
              console.log('No test summary file found, skipping PR comment');
              return;
            }

            let summary = fs.readFileSync(path, 'utf8');
            const hasFailures = '${{ steps.parse-results.outputs.has_failures }}' === 'true';
            const totalTests = '${{ steps.parse-results.outputs.total_tests }}';
            const passed = '${{ steps.parse-results.outputs.passed }}';
            const failed = '${{ steps.parse-results.outputs.failed }}';
            const runId = '${{ github.run_id }}';
            const repo = context.repo;

            // Construct artifact URL
            const artifactUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;

            // Build comment body
            let commentBody = '## ğŸ§ª Apex Test Results\n\n';

            if (hasFailures) {
              commentBody += '### âŒ Tests Failed\n\n';
            } else {
              commentBody += '### âœ… All Tests Passed\n\n';
            }

            commentBody += '```\n' + summary + '\n```\n\n';

            // Add link to full artifact
            commentBody += `ğŸ“¦ **[Download Full Test Results & Logs](${artifactUrl})**\n\n`;

            // Truncate if too long (GitHub comment limit is 65536 chars)
            const maxLength = 65000;
            if (commentBody.length > maxLength) {
              commentBody = commentBody.substring(0, maxLength) + '\n\n... (truncated)\n\n';
              commentBody += `âš ï¸ **Comment truncated due to size.** [Download full results](${artifactUrl})\n`;
            }

            commentBody += `\n---\nğŸ“Š Stats: ${totalTests} total | âœ… ${passed} passed | âŒ ${failed} failed\n`;
            commentBody += `ğŸ¤– _Automated comment by [Salesforce CI](.github/workflows/salesforce-ci-with-build.yml)_`;

            // Find existing comment to update or create new
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ§ª Apex Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: ğŸ“ˆ Upload coverage to Codecov
        if: inputs.upload-to-codecov && inputs.codecov-slug != '' && success()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: ${{ inputs.codecov-slug }}
          flags: Apex
          files: ./tests/apex/test-result-codecoverage.json

      - name: âŒ Fail workflow if tests failed
        if: steps.parse-results.outputs.has_failures == 'true'
        run: |
          echo "âŒ Apex tests failed. Check the test results artifact for details."
          exit 1

      - name: ğŸ§¹ Cleanup scratch org
        if: always()
        run: |
          sf org delete scratch --target-org ScratchOrg --no-prompt || true
          echo "âœ“ Scratch org cleanup completed"
